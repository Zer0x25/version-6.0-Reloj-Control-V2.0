<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Horario y Novedades</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css">
  <style>
    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- ================================== -->
  <!-- ===== SECCI√ìN CONTROL HORARIO ==== -->
  <!-- ================================== -->
  <div id="controlHorarioSection">
    <button class="boton-flotante libro-novedades-btn" id="libroNovedadesBtn" aria-label="Libro de Novedades" title="Libro de Novedades">
      <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="white"><path d="M25,2H7A3,3,0,0,0,4,5V27a3,3,0,0,0,3,3h8V18.1a.5.5,0,0,1,.5-.5h3a.5.5,0,0,1,.5.5V30h3a3,3,0,0,0,3-3V5A3,3,0,0,0,25,2ZM18,29a1,1,0,0,1-1-1V18.1a1.5,1.5,0,0,0-1.5-1.5h-3A1.5,1.5,0,0,0,11,18.1V28a1,1,0,0,1-1,1H7a2,2,0,0,1-2-2V5A2,2,0,0,1,7,3H25a2,2,0,0,1,2,2V27a2,2,0,0,1-2,2Z"/></svg>
    </button>
    <h2>Reloj Control - Espacio OX</h2>

    <div class="header-main">
      <div class="header-selection">
        <input type="search" id="busquedaEmpleado" list="listaBusqueda" placeholder="Buscar empleado por nombre..." aria-label="Buscar empleado" autocomplete="off" />
        <datalist id="listaBusqueda"></datalist>
        <div class="botones-centrados">
          <button class="entrada-btn" id="entradaBtn" aria-label="Registrar entrada">Entrada</button>
          <button class="salida-btn" id="salidaBtn" aria-label="Registrar salida">Salida</button>
        </div>
      </div>
      <div class="header-actions">
        <div class="head-fecha" id="fechaHoraActual"></div>
        <div class="main-actions">
          <button class="admin-button" id="toggleDarkMode" aria-label="Modo oscuro/claro"><span class="icono-modo">üåô</span></button>
          <button class="admin-button" id="adminBtn" aria-label="Administrar empleados">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="24" fill="white" viewBox="0 0 32 32"><path d="M31.7,20.9c-0.1-0.5-0.7-0.8-1.2-0.7c-0.7,0.2-1.2,0-1.3-0.2c-0.1-0.2,0-0.7,0.5-1.3c0.4-0.4,0.4-1,0-1.4 c-1-1-2.2-1.7-3.6-2.1c-0.5-0.1-1.1,0.2-1.2,0.7c-0.2,0.7-0.6,1-0.9,1s-0.6-0.4-0.9-1c-0.2-0.5-0.7-0.8-1.2-0.7 c-1.4,0.4-2.6,1.1-3.6,2.1c-0.4,0.4-0.4,1,0,1.4c0.5,0.5,0.6,1,0.5,1.3c-0.1,0.2-0.6,0.4-1.3,0.2c-0.5-0.1-1.1,0.2-1.2,0.7 C16.1,21.6,16,22.3,16,23s0.1,1.4,0.3,2.1c0.1,0.5,0.7,0.8,1.2,0.7c0.7-0.2,1.2,0,1.3,0.2c0.1,0.2,0,0.7-0.5,1.3 c-0.4,0.4-0.4,1,0,1.4c1,1,2.2,1.7,3.6,2.1c0.1,0,0.2,0,0.3,0c0.4,0,0.8-0.3,1-0.7c0.2-0.7,0.6-1,0.9-1s0.6,0.4,0.9,1 c0.2,0.5,0.7,0.8,1.2,0.7c1.4-0.4,2.6-1.1,3.6-2.1c0.4-0.4,0.4-1,0-1.4c-0.5-0.5-0.6-1-0.5-1.3c0.1-0.2,0.6-0.4,1.3-0.2 c0.5,0.1,1.1-0.2,1.2-0.7c0.2-0.7,0.3-1.4,0.3-2.1S31.9,21.6,31.7,20.9z M24,27c-2.2,0-4-1.8-4-4s1.8-4,4-4c2.2,0,4,1.8,4,4 S26.2,27,24,27z"/><path d="M14,23c0-1.2,0.2-2.3,0.6-3.3c0-0.1,0-0.1,0-0.2c0,0,0.1-0.1,0.1-0.1c0.5-1.2,1.1-2.2,1.9-3.1c0.1-0.4,0.2-0.7,0.3-1.1 c0-0.3,0-0.6-0.2-0.8S16.2,14,15.9,14c-1.1,0-2.1-0.4-2.9-1h6c0.6,0,1-0.4,1-1s-0.4-1-1-1h-0.2v-0.2c0-1.8-0.6-3.4-1.6-4.8l-0.7,2.5 c-0.1,0.4-0.5,0.7-1,0.7c-0.1,0-0.2,0-0.3,0c-0.5-0.2-0.8-0.7-0.7-1.2l1.2-4.1c0-0.3-0.2-0.6-0.5-0.8c-2.6-1.3-5.7-1.3-8.3,0 C6.5,3.1,6.4,3.5,6.3,3.8l1.2,4.1c0.2,0.5-0.2,1.1-0.7,1.2c-0.1,0-0.2,0-0.3,0c-0.4,0-0.8-0.3-1-0.7L4.9,6c-1,1.4-1.6,3-1.6,4.8V11 H3c-0.6,0-1,0.4-1,1s0.4,1,1,1h2v1c0,2.2,0.9,4.2,2.4,5.5c-0.2,1.4-1.1,2.6-2.5,3c-2.5,0.7-4.4,2.9-5,5.7c-0.1,0.5,0,0.9,0.3,1.3 C0.6,29.8,1,30,1.5,30h15.4C15.1,28.2,14,25.7,14,23z"/></svg>
          </button>
        </div>
      </div>
    </div>
    
    <button type="button" class="collapsible-button">Tabla de Registros / Filtros <span class="icono-filtros">‚ñº</span></button>
    <div class="filters-content">
      <div class="filters-grid">
        <div><label for="filtroNombre">Nombre:</label><input type="text" id="filtroNombre"></div>
        <div><label for="filtroArea">√Årea:</label><select id="filtroArea"><option value="">Todos</option></select></div>
        <div><label for="filtroDesde">Desde:</label><input type="date" id="filtroDesde"></div>
        <div><label for="filtroHasta">Hasta:</label><input type="date" id="filtroHasta"></div>
      </div>
      <div class="filter-actions">
        <button id="limpiarFiltrosBtn">Limpiar Filtros</button>
        <button id="exportarCSVBtn">Exportar a CSV</button>
      </div>
    </div>

    <div id="table-container" class="table-responsive">
      <table id="registrosTabla" class="table table-hover table-striped table-bordered align-middle">
        <thead>
          <tr>
            <th>√Årea</th><th>Nombre</th><th>Cargo</th><th>Entrada</th><th>Salida</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="adminPanel" class="admin-panel hidden">
      <div class="admin-header">
        <h3>Administrar Empleados</h3>
        <button class="close-button" id="closeAdminBtn">√ó</button>
      </div>
      <div class="admin-form-grid">
        <div class="form-group"><label for="adminId">ID:</label><input type="text" id="adminId" readonly></div>
        <div class="form-group"><label for="adminNombre">Nombre:</label><input type="text" id="adminNombre"></div>
        <div class="form-group"><label for="adminCargo">Cargo:</label><input type="text" id="adminCargo"></div>
        <div class="form-group"><label for="adminArea">√Årea:</label><input type="text" id="adminArea"></div>
      </div>
      <div class="admin-buttons">
        <button id="nuevoEmpleadoBtn">Crear Nuevo</button>
        <button id="guardarEmpleadoBtn">Guardar/Actualizar</button>
        <button id="eliminarEmpleadoBtn">Eliminar</button>
        <button id="cancelarAdminBtn" class="cancel-button">Cancelar</button>
      </div>
      <h4>Lista de Empleados:</h4>
      <ul id="listaEmpleados"></ul>
      <h4>Logs de Auditor√≠a:</h4>
      <div class="log-actions">
        <button id="verLogsBtn">Ver Logs</button>
        <button id="limpiarLogsBtn" class="hidden">Limpiar Logs</button>
      </div>
      <div id="logsViewer" class="hidden"></div>
    </div>

    <div id="editarRegistroModal" class="modal hidden">
      <div class="modal-content">
        <h3 id="modalTituloEdicion"></h3>
        <div>
          <label for="nuevaFechaHoraInput" class="label-entradaSalida">Nueva Fecha y Hora:</label>
          <input type="datetime-local" id="nuevaFechaHoraInput">
        </div>
        <div class="modal-buttons">
          <button id="btnAceptarEdicion">Aceptar</button>
          <button id="btnCancelarEdicion">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================================== -->
  <!-- ===== SECCI√ìN LIBRO NOVEDADES ==== -->
  <!-- ==================================== -->
  <div id="libroNovedadesSection" class="hidden">
    <button class="boton-flotante control-horario-btn" id="controlHorarioBtn" aria-label="Control Horario" title="Control Horario">
      <svg width="32" height="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="white"><path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20Zm4-9.58L12.5,12.25V7a1,1,0,0,0-2,0v5.75a1,1,0,0,0,.5.86l4,2.5a1,1,0,0,0,.5,1.36,1,1,0,0,0,1.36-.5A1,1,0,0,0,16,16.42Z"/></svg>
    </button>
    <h2>Libro de Novedades - Espacio OX</h2>

    <div class="cabecera-turno" id="cabeceraTurno">
      <div><strong>Folio:</strong> <span id="folioActual"></span></div>
      <div><strong>Fecha:</strong> <span id="fechaActual"></span></div>
      <div><strong>Turno:</strong> <span id="turnoActual"></span></div>
      <div><strong>Responsable:</strong> <span id="responsableActual"></span></div>
    </div>
    <section class="header">
      <div class="main-actions btn-inicio-turno">
        <button class="btn-report" id="abrirReportesBtn">Ver Reportes</button>
        <button class="btn-report" id="reportarTurnoBtn">Cerrar Turno</button>
      </div>
    </section>
    
    <section class="btn2">
      <button id="abrirRegistroBtn">+</button>
      <h3>Registro de Novedades</h3>
    </section>
    <div class="table-responsive">
      <table id="tabla-guardados" class="table table-hover table-striped table-bordered align-middle">
        <thead><tr><th class="col-hora">Hora</th><th class="col-anotacion">Anotaci√≥n</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <section class="btn2">
      <button id="abrirProveedorBtn">+</button>
      <h3>Ingreso de Proveedores</h3>
    </section>
    <div class="table-responsive">
      <table id="tabla-proveedores" class="table table-hover table-striped table-bordered align-middle">
        <thead><tr><th>Hora</th><th>Patente</th><th>Conductor</th><th>+PAX</th><th>Empresa</th><th>Motivo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="modal hidden" id="modalReportes">
      <div class="modal-content">
        <button class="modal-close" id="closeReportesBtn" type="button" aria-label="Cerrar">√ó</button>
        <h4>Reportes de Turno</h4>
        <div id="listadoReportes"></div>
      </div>
    </div>
  </div>

  <footer><p>¬© Zer0x-Iquique 2025</p></footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="utils.js"></script>
  <script src="app.js"></script>
  <script src="libro-novedades.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      
      // --- Cargar Preferencias y Estado Inicial ---
      
      if (obtenerDeLS('darkMode') === true) {
        document.body.classList.add('dark-mode');
        document.querySelector('.icono-modo').textContent = '‚òÄÔ∏è';
      }

      showControlHorario();
      mostrarRegistros();
      popularFiltroArea();
      cargarEmpleadosEnAdmin();
      habilitarArrastreScrollHorizontal('table-container');
      
      // --- Configurar Actualizaci√≥n de Fecha y Hora ---
      const fechaHoraActualDiv = document.getElementById('fechaHoraActual');
      if (fechaHoraActualDiv) {
        const actualizarFechaHora = () => {
          const ahora = new Date();
          const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          const fechaFormateada = ahora.toLocaleDateString('es-CL', opcionesFecha);
          const horaFormateada = ahora.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
          fechaHoraActualDiv.textContent = `${fechaFormateada}, ${horaFormateada}`;
        };
        actualizarFechaHora();
        setInterval(actualizarFechaHora, 1000);
      }

      // --- Asignaci√≥n Centralizada de Event Listeners ---

      const listeners = {
        // Navegaci√≥n
        'libroNovedadesBtn': showLibroNovedades,
        'controlHorarioBtn': showControlHorario,
        'toggleDarkMode': toggleDarkMode,
        // Control Horario
        'entradaBtn': () => registrar('entrada'),
        'salidaBtn': () => registrar('salida'),
        'limpiarFiltrosBtn': limpiarFiltros,
        'exportarCSVBtn': exportarCSV,
        'adminBtn': toggleAdmin,
        'closeAdminBtn': toggleAdmin,
        'cancelarAdminBtn': toggleAdmin,
        // Admin Panel
        'nuevoEmpleadoBtn': nuevoEmpleado,
        'guardarEmpleadoBtn': guardarEmpleado,
        'eliminarEmpleadoBtn': eliminarEmpleado,
        'verLogsBtn': verLogs,
        'limpiarLogsBtn': limpiarLogs,
        // Modal Edici√≥n
        'btnAceptarEdicion': aceptarEdicion,
        'btnCancelarEdicion': cancelarEdicion,
        // Libro Novedades
        'abrirRegistroBtn': abrirModalRegistroNovedad,
        'abrirProveedorBtn': abrirModalRegistroProveedor,
        'reportarTurnoBtn': reportarCierreTurno,
        'abrirReportesBtn': abrirReportes,
        'closeReportesBtn': cerrarModalReportes,
      };

      for (const [id, func] of Object.entries(listeners)) {
        document.getElementById(id)?.addEventListener('click', func);
      }
      
      // Listeners de Input/Change
      document.getElementById('busquedaEmpleado')?.addEventListener('input', buscarEmpleado);
      document.getElementById('busquedaEmpleado')?.addEventListener('change', (e) => e.target.value ? seleccionarEmpleado(e.target.value) : limpiarBusquedaEmpleado());
      document.getElementById('filtroNombre')?.addEventListener('input', mostrarRegistros);
      document.getElementById('filtroArea')?.addEventListener('change', mostrarRegistros);
      document.getElementById('filtroDesde')?.addEventListener('change', mostrarRegistros);
      document.getElementById('filtroHasta')?.addEventListener('change', mostrarRegistros);
      document.getElementById('nuevaFechaHoraInput')?.addEventListener('input', habilitarAceptarEdicion);

      // Listeners de Delegaci√≥n de Eventos
      document.querySelector("#registrosTabla tbody")?.addEventListener('click', manejarAccionRegistro);
      document.querySelector("#registrosTabla tbody")?.addEventListener('dblclick', manejarDobleClicRegistro);

      // --- Configuraci√≥n Adicional ---
      // Collapsible para filtros
      const collapsibleButton = document.querySelector('.collapsible-button');
      collapsibleButton?.addEventListener('click', function() {
        this.classList.toggle('active');
        const content = this.nextElementSibling;
        content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
        content.classList.toggle('expanded');
      });

      // Cierre de modales al hacer clic fuera
      habilitarCierrePorFondo('editarRegistroModal');
      habilitarCierrePorFondo('modalReportes');
    });
  </script>
</body>
</html>